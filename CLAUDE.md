# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Text-to-SQL natural language query system built with Python 3.11, LangChain, and LLM. It allows users to query a MySQL database using natural language questions in Chinese.

**Key Features:**
- Natural language to SQL conversion
- Automatic table identification based on keywords
- Support for multiple LLM providers (OpenAI, DeepSeek, Alibaba Cloud, etc.)
- Interactive query mode
- Database schema extraction and management

## Environment Setup

The project uses a conda environment installed locally:

```bash
# Activate the conda environment
conda activate ./.conda

# Or using the full path
source .conda/bin/activate
```

## Running Python Code

```bash
# Run Python files using the local environment's interpreter
./.conda/bin/python <file>.py

# Or activate the environment first, then use python directly
python <file>.py
```

## Common Commands

### Database Schema Extraction

```bash
# Fetch database schema and sample data
./.conda/bin/python fetch_db_schema.py
```

This generates:
- `database_schema.json` - Full schema with sample data
- `database_schema_for_llm.json` - Simplified version for LLM context
- `database_schema.md` - Human-readable documentation

### Running Text-to-SQL System

```bash
# Set API key first
export OPENAI_API_KEY="your_api_key"

# Run the interactive query system
./.conda/bin/python text_to_sql.py
```

### Installing Dependencies

```bash
# 方式1: 使用requirements.txt (推荐)
./.conda/bin/pip install -r requirements.txt

# 方式2: 手动安装
./.conda/bin/pip install langchain langchain-community langchain-openai sqlalchemy pymysql cryptography python-dotenv
```

## Project Structure

- `.conda/` - Local conda environment (Python 3.11.14)
- `requirements.txt` - Python dependencies list
- `fetch_db_schema.py` - Database schema extraction script
- `text_to_sql.py` - Main Text-to-SQL query system
- `example_usage.py` - Usage examples
- `database_schema.json` - Complete database schema and sample data
- `database_schema_for_llm.json` - Simplified schema for LLM (used as context)
- `database_schema.md` - Human-readable schema documentation
- `.env` - Environment variables (API keys, etc.)
- `.env.example` - Environment variable template
- `README_TEXT_TO_SQL.md` - Detailed usage guide
- `CLAUDE.md` - This file

## Architecture

The system follows this flow:

1. **User Question** (Natural language in Chinese)
2. **Keyword Identification** (Identify relevant database tables)
3. **Schema Loading** (Load table structures and sample data)
4. **SQL Generation** (LLM generates SQL using prompt engineering)
5. **SQL Execution** (Execute on MySQL database)
6. **Results Return** (JSON format with metadata)

### Key Components

- **DatabaseManager** - Handles MySQL connections using SQLAlchemy
- **SchemaManager** - Loads and manages database schema information
- **TextToSQLEngine** - Core engine that uses LangChain to generate and execute SQL
- **TextToSQLApp** - Main application class with interactive mode

### Database Configuration

Target database: `sczsv4.4.1` with 206 tables
- Host: 120.26.37.228:9006
- Read-only user for safety

### LLM Configuration

Supports multiple providers via OpenAI-compatible API:
- OpenAI (GPT-4, GPT-3.5)
- DeepSeek (recommended for Chinese)
- Alibaba Cloud Qwen
- Other OpenAI-compatible endpoints

## Common Query Examples

- "列出所有团队信息" - List all team information
- "我今天打卡了吗" - Did I clock in today
- "显示未完成的任务" - Show incomplete tasks
- "团主是谁" - Who is the team leader
- "当月的销售任务有哪些" - What are this month's sales tasks

## Notes

- The conda environment is stored locally in the repository
- Python version: 3.11.14
- Database queries are automatically limited to prevent large result sets
- Schema files are regenerated by running `fetch_db_schema.py`
- API keys should be stored in `.env` file or environment variables
